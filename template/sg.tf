
data "aws_security_group" "sg" {
  #  id = "${var.security_group_id}"
  id = "${aws_security_group.sg.id}"
}

variable "ips" {
  default = [
    #edit
    "192.168.1.101/32",

    "192.168.1.102/32",
    "192.168.1.103/32",
    "192.168.1.104/32",
    "192.168.1.105/32",
    "192.168.1.106/32",
    "192.168.1.107/32",
    "192.168.1.108/32",
    "192.168.1.109/32",
    "192.168.1.110/32",
    "192.168.1.111/32",
    "192.168.1.112/32",
    "192.168.1.113/32",
    "192.168.1.114/32",
    "192.168.1.115/32",
    "192.168.1.116/32",
    "192.168.1.117/32",
    "192.168.1.118/32",
    "192.168.1.119/32",
    "192.168.1.120/32",
    "192.168.1.121/32",
    "192.168.1.122/32",
    "192.168.1.123/32",
    "192.168.1.124/32",
    "192.168.1.125/32",
    "192.168.1.126/32",
    "192.168.1.127/32",
    "192.168.1.128/32",
    "192.168.1.129/32",
    "192.168.1.130/32",
    "192.168.1.131/32",
    "192.168.1.132/32",
    "192.168.1.133/32",
    "192.168.1.134/32",
    "192.168.1.135/32",
    "192.168.1.136/32",
    "192.168.1.137/32",
    "192.168.1.138/32",
    "192.168.1.139/32",
    "192.168.1.140/32",
    "192.168.1.141/32",
    "192.168.1.142/32",
    "192.168.1.143/32",
    "192.168.1.144/32",
    "192.168.1.145/32",
    "192.168.1.146/32",
    "192.168.1.147/32",
    "192.168.1.148/32",
    "192.168.1.149/32",
    "192.168.1.150/32",
    "192.168.1.151/32",
    "192.168.1.152/32",
    "192.168.1.153/32",
    "192.168.1.154/32",
    "192.168.1.155/32",
    "192.168.1.156/32",
    "192.168.1.157/32",
    "192.168.1.158/32",
    "192.168.1.159/32",
    "192.168.1.160/32",
    "192.168.1.161/32",
    "192.168.1.162/32",
    "192.168.1.163/32",
    "192.168.1.164/32",
    "192.168.1.165/32",
    "192.168.1.166/32",
    "192.168.1.167/32",
    "192.168.1.168/32",
    "192.168.1.169/32",
    "192.168.1.170/32",
    "192.168.1.171/32",
    "192.168.1.172/32",
    "192.168.1.173/32",
    "192.168.1.174/32",
    "192.168.1.175/32",
    "192.168.1.176/32",
    "192.168.1.177/32",
    "192.168.1.178/32",
    "192.168.1.179/32",
    "192.168.1.180/32",
    "192.168.1.181/32",
    "192.168.1.182/32",
    "192.168.1.183/32",
    "192.168.1.184/32",
    "192.168.1.185/32",
  ]
}

locals {
  ips = "${chunklist(var.ips,45)}"
}

resource "aws_security_group" "sg" {
  count       = "${length(chunklist(var.ips,45))}"
  name_prefix = "${terraform.workspace}-sg"
  description = "self"
  vpc_id      = "${data.aws_vpc.vpc.id}"

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = "${merge(var.tags, map("Name", "${terraform.workspace}-sg-sec"),map("Env",terraform.workspace))}"
}

resource "aws_security_group_rule" "sg1" {
  type              = "ingress"
  from_port         = 0
  to_port           = 65535
  protocol          = "-1"
  self              = true
  security_group_id = "${aws_security_group.sg.id}"
}

resource "aws_security_group_rule" "sg2" {
  count             = "${length(chunklist(var.ips,45))}"
  type              = "ingress"
  from_port         = 0
  to_port           = 0
  protocol          = "-1"
  cidr_blocks       = "${local.ips[count.index]}"
  security_group_id = "${aws_security_group.sg.id}"
}
